<!-- Calcite Components -->
<script type="module" src="https://js.arcgis.com/calcite-components/2.4.0/calcite.esm.js"></script>
<link rel="stylesheet" href="https://js.arcgis.com/calcite-components/2.4.0/calcite.css" />

<!-- CONTENEDOR CENTRADO -->
<div style="display:flex; justify-content:center; width:100%;">

  <!-- BOTÓN / ETIQUETA DE VISITAS (NO CLICKEABLE) -->
  <div id="contador" style="
      font-family:Arial; 
      font-size:14px; 
      font-weight:bold;
      color:#FFFFFF; 
      background:transparent; 
      padding:8px 14px;
      border-radius:6px;
      border:1px solid #0E4C5B;
      display:flex; 
      align-items:center; 
      gap:6px;
      cursor:default;
      width:auto;             /* ajuste automático al contenido */
      text-align:center;">
    
    <calcite-icon icon="view-mixed" scale="s" style="color:white;"></calcite-icon>
    <span id="contador-texto">Cargando visitas...</span>

  </div>

</div>

<script>
(async () => {

  /* ===============================
     ENMASCARAMIENTO DEL URL
     =============================== */

  // URL dividido para evitar que nadie lo copie completo
  const p1 = "https://services8.arcgis.com/";
  const p2 = "dD73nM2okbQuDi0w/arcgis/rest/services/";
  const p3 = "Visitas_Geoportal/FeatureServer/0";
  const tableUrl = p1 + p2 + p3;

  // Visitas previas antes de crear contador
  const BASE_VISITAS = 7464;

  /* ===============================
     FUNCIONES DEL CONTADOR
     =============================== */

  async function getLayerInfo() {
    const res = await fetch(tableUrl + "?f=json");
    return res.ok ? res.json() : null;
  }

  function detectFields(layerInfo) {
    const fields = layerInfo?.fields || [];

    const countFieldObj = fields.find(
      f => /count|cantidad|cnt|numero/i.test(f.name) && f.type.includes("Integer")
    );
    const countField = countFieldObj ? countFieldObj.name :
                       (fields.find(f => f.type.includes("Integer")) || {}).name;

    const dateFieldObj = fields.find(
      f => /visit|fecha|date/i.test(f.name) && f.type.includes("Date")
    );
    const dateField = dateFieldObj ? dateFieldObj.name :
                      (fields.find(f => f.type.includes("Date")) || {}).name;

    return { countField, dateField };
  }

  async function registerVisit(countField, dateField) {
    const now = Date.now();
    const attributes = {};

    if (dateField) attributes[dateField] = now;
    if (countField) attributes[countField] = 1;

    const feature = { attributes };
    const fd = new FormData();
    fd.append("f", "json");
    fd.append("features", JSON.stringify([feature]));

    const r = await fetch(tableUrl + "/addFeatures", { method: "POST", body: fd });
    return r.json();
  }

  async function getVisitCount(countField) {
    // Método 1
    try {
      const params = new URLSearchParams({
        f: "json",
        where: "1=1",
        returnCountOnly: "true"
      });
      const res = await fetch(tableUrl + "/query?" + params.toString());
      const json = await res.json();
      if (typeof json.count === "number") return json.count;
    } catch {}

    // Método 2
    try {
      const outStats = JSON.stringify([{
        statisticType: "sum",
        onStatisticField: countField,
        outStatisticFieldName: "total"
      }]);

      const params = new URLSearchParams({
        f: "json",
        where: "1=1",
        outStatistics: outStats
      });

      const res = await fetch(tableUrl + "/query?" + params.toString());
      const json = await res.json();

      if (json?.features?.[0]?.attributes?.total != null)
        return json.features[0].attributes.total;
    } catch {}

    return 0;
  }

  /* ===============================
     EJECUCIÓN GENERAL
     =============================== */

  try {
    const layerInfo = await getLayerInfo();
    if (!layerInfo) throw new Error("No metadata.");

    const { countField, dateField } = detectFields(layerInfo);

    await registerVisit(countField, dateField);

    const total = await getVisitCount(countField);

    document.getElementById("contador-texto").textContent =
      `${total + BASE_VISITAS} Visitas`;

  } catch (err) {
    document.getElementById("contador-texto").textContent = "Error de conexión";
  }

})();
</script>
